name: "Test and Setup CI Device"
description: "Installs tools and sets up environment for the CI "
runs:
  using: "composite"
  steps:
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.27.4"
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
    - name: 'Setup the CI device by installing dependencies'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgtk-3-dev

        flutter config --enable-linux-desktop
        sudo apt-get install -y xvfb
        cargo install flutter_rust_bridge_codegen
        flutter_rust_bridge_codegen generate

        cd rust
        cargo fetch
        cargo test -- --show-output
        cargo build --release

        cd ..
        flutter clean
        flutter pub get

        cd example
        xvfb-run --auto-servernum -- flutter test -d linux integration_test/master_integration_test.dart
        


